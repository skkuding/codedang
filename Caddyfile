(cors) {
	@cors_preflight{args[0]} {
		# cors_preflight{args[0]} matcher 생성
		header Origin {args[0]} # header와 method를 조건으로 설정
		method OPTIONS
	}
	@cors{args[0]} header Origin {args[0]} # cors{args[0]} matcher 생성

	handle @cors_preflight{args[0]} {
		# cors_preflight{args[0]}를 처리할 handler
		header Access-Control-Allow-Credentials true
		header Access-Control-Allow-Origin "{args[0]}"
		header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE"
		header Access-Control-Allow-Headers "Content-Type, Authorization, Email-Auth"
		respond "" 204
	}

	handle @cors{args[0]} {
		# cors{args[0]}를 처리할 handler
		header Access-Control-Allow-Origin "{args[0]}"
	}
}

dev.codedang.com {
	handle /api/* {
		reverse_proxy 127.0.0.1:4000 {
			# Keep-Alive timeout of Caddy must be longer than of the backend
			# To prevent error, let's just turn keepalive off (performance is not a big deal)
			# https://stackoverflow.com/questions/66911457/my-nodejs-app-show-502-error-for-no-reason
			transport http {
				keepalive off
			}
		}

		# 캐시 설정
		header {
			Set-Cookie (.*) "$1; SameSite=None; Secure"
			defer
		}

		# cors 허용할 도메인
		import cors http://localhost:5173 # frontend server (Vue)
		import cors http://localhost:5525 # frontend server (Next.js)
	}

	handle /logs/* {
		reverse_proxy 127.0.0.1:9999
	}

	handle /graphql {
		reverse_proxy 127.0.0.1:3000 {
			transport http {
				keepalive off
			}
		}

		# cors 허용할 도메인
		import cors http://localhost:5173 # frontend server (Vue)
		import cors http://localhost:5525 # frontend server (Next.js)
	}

	handle {
		reverse_proxy https://codedang.vercel.app {
			# Must override host to avoid Vercel error
			header_up Host codedang.vercel.app
		}
	}
}
