name: Preview Cleanup

on:
  schedule:
    - cron: '0 19 * * *' # Daily at 4 AM KST (UTC+9)
  workflow_dispatch:

jobs:
  cleanup-stale-previews:
    name: Cleanup Stale Previews
    runs-on: ubuntu-latest

    steps:
      - name: Generate token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.SKKUDING_BOT_APP_ID }}
          private-key: ${{ secrets.SKKUDING_BOT_PRIVATE_KEY }}

      - name: Remove preview label from stale PRs
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const STALE_DAYS = 7;

            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              per_page: 100
            });

            const previewPRs = prs.filter(pr =>
              pr.labels.some(l => l.name === 'preview')
            );

            core.info(`Found ${previewPRs.length} open PRs with 'preview' label`);

            const now = new Date();

            for (const pr of previewPRs) {
              const { data: commit } = await github.rest.git.getCommit({
                owner,
                repo,
                commit_sha: pr.head.sha
              });

              const commitDate = new Date(commit.committer.date);
              const daysSinceCommit = (now - commitDate) / (1000 * 60 * 60 * 24);

              if (daysSinceCommit > STALE_DAYS) {
                const lastActivity = commitDate.toISOString().split('T')[0];

                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number: pr.number,
                  name: 'preview'
                });

                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: pr.number,
                  body: [
                    'ðŸ›‘ **Preview Removed**',
                    '',
                    `**Reason:** No commits for ${STALE_DAYS} days (stale)`,
                    `**Last Activity:** ${lastActivity}`,
                    '',
                    'Push a new commit to restore the preview.'
                  ].join('\n')
                });

                core.info(`Removed 'preview' from stale PR #${pr.number} (last commit: ${lastActivity})`);
              }
            }
