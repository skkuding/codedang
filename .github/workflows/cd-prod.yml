# This workflow only builds and pushes Docker images.
# The rest of the deployment process is handled by ArgoCD.
name: CD - Production

on:
  push:
    branches: [release, t2076-release-pipeline]

permissions:
  contents: read
  packages: write

jobs:
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/build-and-push-image
        with:
          file: ./apps/frontend/Dockerfile
          tags: |
            ghcr.io/skkuding/codedang-frontend:production
            ghcr.io/skkuding/codedang-frontend:${{github.sha}}

  build-client-api:
    name: Build Client API
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/build-and-push-image
        with:
          file: ./apps/backend/Dockerfile
          build-args: |
            target=client
            app_env=production
          tags: |
            ghcr.io/skkuding/codedang-client-api:production
            ghcr.io/skkuding/codedang-client-api:${{github.sha}}

  build-admin-api:
    name: Build Admin API
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/build-and-push-image
        with:
          file: ./apps/backend/Dockerfile
          build-args: |
            target=admin
            app_env=production
          tags: |
            ghcr.io/skkuding/codedang-admin-api:production
            ghcr.io/skkuding/codedang-admin-api:${{github.sha}}

  build-iris:
    name: Build Iris
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/build-and-push-image
        with:
          context: apps/iris
          build-args: |
            app_env=stage
          tags: |
            ghcr.io/skkuding/codedang-iris:production
            ghcr.io/skkuding/codedang-iris:${{github.sha}}
